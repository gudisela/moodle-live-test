<!DOCTYPE html>
<html>
<head>
    <title>Draw on Diagram</title>
    <style>
        #container {
            position: relative;
            width: 800px;
        }
        #background {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            border: 1px solid #222;
        }
    </style>
</head>
<body>

<h2>Draw on Diagram: {{ diagram_name }}</h2>

<div id="container">
    <!-- Background diagram image -->
    <img id="background"
         src="/get_diagram/{{ diagram_name }}"
         onload="resizeCanvas(this)"
    />

    <!-- Drawing canvas -->
    <canvas id="overlay"></canvas>
</div>

<button onclick="saveDrawing()">Save Diagram</button>

<script>
function resizeCanvas(img) {
    let canvas = document.getElementById("overlay");
    canvas.width = img.width;
    canvas.height = img.height;

    window.ctx = canvas.getContext("2d");
    setupDrawing();
}

function setupDrawing() {
    let canvas = document.getElementById("overlay");
    let drawing = false;

    canvas.addEventListener("mousedown", () => drawing = true);
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mousemove", draw);

    function draw(e) {
        if (!drawing) return;
        ctx.lineWidth = 3;
        ctx.lineCap = "round";
        ctx.strokeStyle = "red";
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
    }
}

function saveDrawing() {
    let canvas = document.getElementById("overlay");
    let imageData = canvas.toDataURL("image/png");

    fetch("/save_diagram", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            imageData: imageData,
            sourceDiagram: "{{ diagram_name }}"
        })
    })
    .then(res => res.json())
    .then(data => alert("Saved: " + data.file));
}
</script>

</body>
</html>
