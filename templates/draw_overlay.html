<!DOCTYPE html>
<html>
<head>
    <title>Draw on Diagram</title>
    <style>
        body {
            text-align: center;
            font-family: Arial;
        }

        #container {
            position: relative;
            display: inline-block;
        }

        #bg {
            position: absolute;
            left: 0;
            top: 0;
            z-index: 1;
        }

        #draw {
            position: absolute;
            left: 0;
            top: 0;
            z-index: 2;
        }

        #controls {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h2>Complete the Diagram</h2>

<form method="POST" action="{{ submit_url }}" onsubmit="return mergeImages()">
    <input type="hidden" name="merged_image" id="merged_image">

    <div id="container">
        <!-- Background (diagram) -->
        <img id="bg" src="/static/diagrams/{{ diagram_filename }}">

        <!-- Top canvas for drawing -->
        <canvas id="draw"></canvas>
    </div>

    <div id="controls">
        <label>Pen size:</label>
        <input type="range" id="size" min="1" max="10" value="3">

        <label>Colour:</label>
        <input type="color" id="color" value="#000000">

        <button type="button" onclick="clearCanvas()">Clear</button>
        <button type="submit">Submit</button>
    </div>
</form>

<script>
let canvas = document.getElementById("draw");
let ctx = canvas.getContext("2d");
let bg = document.getElementById("bg");

bg.onload = function() {
    canvas.width = bg.width;
    canvas.height = bg.height;
};

let drawing = false;

canvas.addEventListener("mousedown", () => drawing = true);
canvas.addEventListener("mouseup", () => drawing = false);
canvas.addEventListener("mouseleave", () => drawing = false);

canvas.addEventListener("mousemove", function(e) {
    if (!drawing) return;

    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;

    ctx.lineWidth = document.getElementById("size").value;
    ctx.strokeStyle = document.getElementById("color").value;
    ctx.lineCap = "round";

    ctx.lineTo(x, y);
    ctx.stroke();
});

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
}

function mergeImages() {
    let merged = document.createElement("canvas");
    let mctx = merged.getContext("2d");

    merged.width = bg.width;
    merged.height = bg.height;

    mctx.drawImage(bg, 0, 0);      // background
    mctx.drawImage(canvas, 0, 0);  // drawing overlay

    document.getElementById("merged_image").value = merged.toDataURL();

    return true;
}
</script>

</body>
</html>
