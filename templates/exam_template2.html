<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Exam Question — {{ qid }}</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--canvas-w:900px; --canvas-h:650px; --diagram-target-w:600px;}
  body{font-family:Arial, Helvetica, sans-serif; margin:14px; color:#111;}
  h2{margin-bottom:10px;}
  .container{display:flex; gap:18px; align-items:flex-start;}
  @media(max-width:900px){ .container{flex-direction:column;} }
  .qpanel{ flex:0 0 48%; max-width:48%; min-width:260px; border:1px solid #ddd; padding:12px; box-sizing:border-box; background:#fafafa; overflow:hidden; }
  .qpanel h3{margin-top:0;}
  .qimg-wrap{ width:100%; height: calc(100vh - 220px); overflow:auto; border:1px dashed #eee; padding:8px; box-sizing:border-box; background:#fff; }
  .qimg-wrap img{display:block; width:100%; height:auto; object-fit:contain;}
  .dpanel{ flex:0 0 52%; max-width:52%; min-width:300px; box-sizing:border-box; text-align:center; }
  .canvas-wrapper{ width: var(--canvas-w); height: var(--canvas-h); max-width:100%; border:1px solid #bbb; margin: 0 auto; position: relative; background:#fff; touch-action: none; }
  #bgImg{ display:none; }
  .controls{ margin-top: 10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
  .controls button, .controls input[type="range"], .controls select { padding:8px 10px; font-size:14px; }
  .small { font-size:13px; color:#444; margin-top:6px; text-align:center; }
  .answer-area{ margin-top:14px; }
  .answer-area textarea{ width:100%; min-height:110px; padding:10px; font-size:15px; box-sizing:border-box; }
  .meta-row{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; align-items:center; }
  .meta-row input[type="text"]{ padding:8px; font-size:14px; width:220px; }
</style>
</head>
<body>
  <h2>Question {{ qid }}</h2>

  <div class="container">
    <div class="qpanel" aria-label="Question text">
      <h3>Question (Read-only)</h3>
      <div class="qimg-wrap" id="qimgWrap">
        <img id="questionImage" src="/question_file/{{ qid }}/{{ question_image }}" alt="Question image">
      </div>
      <div class="small">Scroll the question area if needed. Pinch/zoom the diagram to draw precisely.</div>
    </div>

    <div class="dpanel" aria-label="Drawing area">
      <h3>Diagram — draw in the box (you may draw outside the printed diagram)</h3>

      <div class="canvas-wrapper" id="canvasWrapper">
        <img id="bgImg" src="/question_file/{{ qid }}/{{ diagram_image }}" alt="Diagram to draw on">
        <canvas id="drawCanvas" width="900" height="650" style="display:block;"></canvas>
      </div>

      <div class="controls">
        <label>Pen size <input id="penSize" type="range" min="1" max="10" value="3"></label>
        <label>Tool
          <select id="tool">
            <option value="draw">Draw</option>
            <option value="erase">Eraser</option>
            <option value="line">Straight line</option>
          </select>
        </label>
	<button id="freeDrawBtn">Free Draw</button>
	<button id="lineDrawBtn">Straight Line</button>
	<button id="eraseBtn">Eraser</button>

        <button id="undoBtn">Undo</button>
        <button id="clearBtn">Clear</button>
        <button id="submitBtn">Submit</button>
      </div>

      <div class="small">Tip: use one finger for drawing. Use two fingers to pinch-zoom or to pan. On desktop use mouse wheel to zoom.</div>

      <div class="answer-area">
        <label><strong>Type your short answers here (write parts in order):</strong></label>
        <textarea id="answerText" placeholder="(a) ...  (b) ..."></textarea>

        <div class="meta-row">
          <input id="studentName" type="text" placeholder="Student name (required)">
          <div style="flex:1"></div>
          <span id="statusText" class="small"></span>
        </div>
      </div>
    </div>
  </div>


<script>
const canvas = document.getElementById("drawingCanvas");
const ctx = canvas.getContext("2d");

let drawMode = "free";     // free | line | erase
let isDrawing = false;
let startX = 0, startY = 0;
let currentX = 0, currentY = 0;

// For line preview
let previewActive = false;

// =============================
// 1. TOOL BUTTONS
// =============================
document.getElementById("freeDrawBtn").onclick = () => {
    drawMode = "free";
};
document.getElementById("lineDrawBtn").onclick = () => {
    drawMode = "line";
};
document.getElementById("eraseBtn").onclick = () => {
    drawMode = "erase";
};

// =============================
// 2. MOUSE + TOUCH HELPERS
// =============================
function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches) e = e.touches[0];
    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

canvas.addEventListener("mousedown", startDrawing);
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("mouseup", endDrawing);

canvas.addEventListener("touchstart", startDrawing);
canvas.addEventListener("touchmove", draw);
canvas.addEventListener("touchend", endDrawing);

// =============================
// 3. DRAWING START
// =============================
function startDrawing(e) {
    const pos = getPos(e);
    startX = pos.x;
    startY = pos.y;

    if (drawMode === "line") {
        previewActive = true;
    }

    isDrawing = true;

    if (drawMode === "free" || drawMode === "erase") {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    }
}

// =============================
// 4. DRAWING MOVE
// =============================
function draw(e) {
    if (!isDrawing) return;

    const pos = getPos(e);

    if (drawMode === "free") {
        ctx.lineWidth = 2;
        ctx.strokeStyle = "black";
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    else if (drawMode === "erase") {
        ctx.lineWidth = 20;
        ctx.strokeStyle = "white";
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    else if (drawMode === "line") {
        // Live preview
        currentX = pos.x;
        currentY = pos.y;

        // Clear preview layer
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Redraw saved content
        ctx.drawImage(savedLayer, 0, 0);

        // Draw preview line
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(currentX, currentY);
        ctx.lineWidth = 2;
        ctx.strokeStyle = "black";
        ctx.stroke();
    }
}

// =============================
// 5. DRAWING END
// =============================
function endDrawing() {
    if (!isDrawing) return;
    isDrawing = false;

    if (drawMode === "line" && previewActive) {
        previewActive = false;

        // Commit the final straight line into savedLayer
        ctx.drawImage(savedLayer, 0, 0);  // restore previous
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(currentX, currentY);
        ctx.lineWidth = 2;
        ctx.strokeStyle = "black";
        ctx.stroke();

        // Update savedLayer
        savedLayer.getContext("2d").drawImage(canvas, 0, 0);
    } else {
        // Save all free-draw strokes
        savedLayer.getContext("2d").drawImage(canvas, 0, 0);
    }
}

// =============================
// 6. STATIC SAVED LAYER
// =============================
const savedLayer = document.createElement("canvas");
savedLayer.width = canvas.width;
savedLayer.height = canvas.height;
</script>

</body>
</html>
